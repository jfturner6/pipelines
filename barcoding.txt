# See metabarcoding.txt if you need to do demultiplexing

# A command for running trimming on paired files in a loop. Assumes _R[12].fq. Make sure to check directory names and insert any project names into the for loop to ensure you don't run on anyone else's files. -g is forward, -G is reverse primer

mkdir 1_trimmed
while read s; do cutadapt -j 20 -g CCNGAYATRGCNTTYCCNCG -G TANACYTCNGGRTGNCCRAARAAYCA -o 1_trimmed/${s}_R1.fastq -p 1_trimmed/${s}_R2.fastq --discard-untrimmed 0_demux/${s}_R1.fq 0_demux/${s}_R2.fq; done < <(for f in 0_demux/*.fq; do s1=${f#*/}; echo ${s1%_*}; done | sort | uniq)

# Running merging
mkdir 2_merged
while read l; do pear -f 1_trimmed/${l}_R1.fastq -r 1_trimmed/${l}_R2.fastq -o 2_merged/$l -q 26 -v 60 -j 20; done < <(for f in 1_trimmed/*; do s1=${f#*/}; echo ${s1%_*}; done | sort | uniq)
cd 2_merged/
rm *discarded* *unassembled* && rename -e "s/assembled\.//" *
cd ../

# Quality filter
mkdir 3_filtered
for f in 2_merged/*.fastq; do o=${f%.fastq}.fasta; vsearch --fastx_filter $f --fastq_maxee 1 --fastaout 3_filtered/${f#*/}; done

# Then run NAPselect on the files in 3_filtered
